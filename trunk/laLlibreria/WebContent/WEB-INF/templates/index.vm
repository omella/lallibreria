#parse("WEB-INF/templates/header.vm")

<script src="http://maps.google.com/maps/api/js?sensor=false" type="text/javascript"></script>
<script type="text/javascript">

//INICIO: Geolocalizacion Google
//determine support for geolocation
if (navigator.geolocation){
//locate position
navigator.geolocation.getCurrentPosition(displayPosition, errorFunction);
 }
else{
alert('It seems like Geolocation, which is required for this page, is not enabled in your browser. Please use a browser which supports it.');
}

var map;
//success callback function
function displayPosition(pos){
	var mylat = pos.coords.latitude;
	var mylong = pos.coords.longitude;
	var thediv = document.getElementById("map_canvas");
	//Load Google Map
	var latlng = new google.maps.LatLng(mylat, mylong);
	    var myOptions = {
	      zoom: 15,
	      center: latlng,
	      mapTypeId: google.maps.MapTypeId.HYBRID
	    };
	
	map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

	//Add marker
	var marker = new google.maps.Marker({
		     position: latlng, 
		     map: map, 
		     title:"You are here"
		 });    
	 addLibreriaMapa(latlng);
 }

//error callback function
function errorFunction(pos){
	alert('Error!');
}

//FIN: Geolocalizacion Google

//INICIO:Localizar "manualmente"

var geocoder;
function localizar(){
    geocoder = new google.maps.Geocoder();

	var address = document.getElementById("localizacion").value;
    if (geocoder) {
      geocoder.geocode( { 'address': address}, function(results, status) {
        if (status == google.maps.GeocoderStatus.OK) {
          //alert(results[0].geometry.location);
          map.setCenter(results[0].geometry.location);
          var marker = new google.maps.Marker({
              map: map, 
              position: results[0].geometry.location
          });
          addLibreriaMapa(results[0].geometry.location);
        } else {
          alert("Geocode was not successful for the following reason: " + status);
        }
      });
    }

}
//FIN:Localizar "manualmente"
//INICIO: Situar librerias


var distance = -1;

function addLibreriaMapa(posicionCliente){
	geocoder2 = new google.maps.Geocoder();
	var arrayAddress = ["Av. Colon, Tortosa",#foreach ($llib in $llibreriaList)
							"${llib.place}",
     					#end
     					"Av. Colon, Tortosa"] 
     					
    if (geocoder2) {
        var i;
      	for (i=0;i<arrayAddress.length;i++){
      	   geocoder2.geocode( { 'address': arrayAddress[i]}, function(results2, status2) {
			    var marker2;
		        if (status2 == google.maps.GeocoderStatus.OK) {
		          marker2 = new google.maps.Marker({
		              map: map, 
		              position: results2[0].geometry.location,
		              icon: 'http://google-maps-icons.googlecode.com/files/library.png'
		          });
		  
		          marker2.openInfoWindowHtml('Algun Texto'); 
		  		  map.addOverlay(marker2);
		        } else {
		          alert("Geocode was not successful for the following reason: " + status);
		        }
		 
	      });
	   } 
    }
}

function getDistance(posC,posL) {
	var directionsService = new google.maps.DirectionsService();

	directionsDisplay = new google.maps.DirectionsRenderer(
	{
	   suppressMarkers: true,
	   suppressInfoWindows: true
	});

	directionsDisplay.setMap(map);
	var request = {
	   origin:posC,
	   destination:posL,
	   travelMode: google.maps.DirectionsTravelMode.WALKING
	};
	var distance;
	directionsService.route(request, function(response, status)
	{
		
	   if (status == google.maps.DirectionsStatus.OK)
	   {      
	       distance = response.routes[0].legs[0].distance.text;
	   }
	  
	});
		
}


//FIN
</script>

<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript">
  google.load('friendconnect', '0.8');
</script>


<body>
   <div id=page>
     <div id=top>
     	<div id=login>
			Usuario: "Admin" - Password: "Admin"
			#if ($error)
				<p><font color="red">${error}</font></p>
			#end
			
     		#sform ("action=doLogin")
				#stextfield ("label=Usuario"  "name=username")
				#spassword  ("label=Password" "name=password")
				#ssubmit ("value=Login")
        	#end

        	<div id="fb-root"></div>
	<script type="text/javascript">
		window.fbAsyncInit = function() {
			FB.init({appId: '177068509007802', status: true, cookie: true, xfbml: true});

			FB.Event.subscribe('auth.login', function(response) {
				login();
			});
			FB.Event.subscribe('auth.logout', function(response) {
				logout();
			});

			FB.getLoginStatus(function(response) {
				if (response.session) {
					greet();
				}
			});
		};
		(function() {
			var e = document.createElement('script');
			e.type = 'text/javascript';
			e.src = document.location.protocol +
				'//connect.facebook.net/en_US/all.js';
			e.async = true;
			document.getElementById('fb-root').appendChild(e);
		}());

		function login(){
			FB.api('/me', function(response) {
				alert('You have successfully logged in, with facebook, '+response.name+"!");
			   	window.location = "alexLogin.action"
			});
		}
		function logout(){
			window.location = "alexLogout.action"
		}
		function greet(){
			FB.api('/me', function(response) {
			});
		}

		function setStatus(){
		
			// check if user is logged in:
			FB.getLoginStatus(function(response) {
			  if (response.session) {
					new_status = document.getElementById('status').value;
					FB.api(
					  {
						method: 'status.set',
						status: new_status
					  },
					  function(response) {
						if (response == 0){
							alert('Your facebook status not updated. Give Status Update Permission.');
						}
						else{
							alert('Your facebook status updated');
						}
					  }
					);
			  } else {
					alert('please log in first :)');
			  }
			});
		
			
		}
	</script>
	<fb:login-button autologoutlink='true' perms='email,user_checkins,user_about_me'></fb:login-button>
   <script type="text/javascript">
    var SITE_ID = '06834717057300479661';
    var viewer, ownerFriends, activities;
    var logged;
    google.friendconnect.container.setParentUrl('/laLlibreria/' /* location of rpc_relay.html and canvas.html */);
    google.friendconnect.container.loadOpenSocialApi({ 
            site: SITE_ID,
            onload: function() { initAllData(); }});

    function initAllData() {
      var params = {};
      params[opensocial.DataRequest.PeopleRequestFields.PROFILE_DETAILS] =
        [opensocial.Person.Field.ID,opensocial.Person.Field.NAME,opensocial.Email.Field.ADDRESS,opensocial.Person.Field.THUMBNAIL_URL,opensocial.Person.Field.PROFILE_URL];
      var req = opensocial.newDataRequest();
      req.add(req.newFetchPersonRequest('VIEWER', params), 'viewer');
      req.add(req.newFetchPeopleRequest(
        new opensocial.IdSpec({'userId' : 'OWNER', 'groupId' : 'FRIENDS'}), params), 
        'ownerFriends');
      req.add(req.newFetchActivitiesRequest(new opensocial.IdSpec({'userId' : 'OWNER', 'groupId' : 'FRIENDS'})), 'activities');
      req.send(setupData);
    };

    function setupData(data) {
	  
      viewer = data.get('viewer').getData();
      if (viewer) {
      	if(logged == 0){
      	    alert('Welcome, with google ' + viewer.getField("displayName")+ " " + viewer.getId("")+"!");
      	    window.location = "alexLogin.action"
      	}
      	logged=1;
      	
      }
	  
      viewer = data.get('viewer').getData();
      if (viewer) {
        document.getElementById('profile').innerHTML =  
        '<img align="left" src="' + viewer.getField("thumbnailUrl")  + '">' +
        '<b>' + " WELLCOME " +  viewer.getField("displayName")+ " from Google" + '!</b><br>' +
        '<a href=/laLlibreria/alexLogout.action onclick="google.friendconnect.requestSignOut(); return false;">Sign out</a><br>';
      } else {
        logged = 0;
        google.friendconnect.renderSignInButton({ 'id': 'profile', 'style': 'long' });
        
      }
    };
    </script>
	<div id="profile"></div>  
        	<a href=/laLlibreria/showRegistreLlibreria.action>Ets una llibreria?</a> 
     	</div>
     	<div id=buscador>
     		<h1>Llibre</h1> 
			#sform ("action=searchBookAjax" "method=get")
				#stextfield ("name=key") 
				#shidden ("name=page" "value=1")
				#ssubmit ("value=Search")
        	#end

            #if ($msg)
            	<p><font color="red">${msg}</font></p>
            #end
     	</div>
     	<div id=seccionOfertas>
     		Mejores ofertas:
	     	<div id=ofertas>
	     		#foreach ($oferta in $millorOfertes)  
	     			<div id=oferta1>Llibreria: ${oferta.llibreria_name} | Tematica: ${oferta.tematica} | Descompte: ${oferta.valor} </div>
	     		#end
	     	</div>
	    </div>
     </div>
     <div id=leftContent>
	    #if ($msg)
			<font color="red">${numberResults} ${msg}</font>
		#end
		#if ($results)
			Aquesta es la pagina ${page} de ${totalPages} pagines de resultats
		#end
		#parse("WEB-INF/templates/resultAjax.vm");     
     </div>
     <div id=rightContent>
     	<div id=map_canvas></div>
     	<div id=ubicacion>
     		<div id=inputCalle>
     			<span id=textoBlanco>&iquest;Estas bien localizado?</span><br/><br/>
     			<span id=textBox><input id="localizacion" type="text" value="Calle, Ciudad" style="color:grey; width:350px" onfocus="if(this.value==this.defaultValue) this.value=''">
     			<input name="localiza" type="button" value="Localizar" onclick="localizar()"></span>
     		</div>
     		<div id=librosBuscados>
     		   <table border="1">
			   <span id=textoBlanco>Llibres mes populars</span>
			   #foreach ($popular in $populars)
					<tr>
						<td>
							<img src="${popular.thumb}" alt=""/>
						</td>
						<td>
							<a href=/laLlibreria/showBook.action?id=${popular.isbn}> ${popular.title}</a>, ${popular.author}
						</td>
					</tr>
			   #end
			   </table>
     		</div>
     		
     	</div>
     </div>
     <div id=foot>
     	#parse( "WEB-INF/templates/pie.vm" )
     </div>
   </div>

 </body>
</html>